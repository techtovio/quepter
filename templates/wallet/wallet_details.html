{% extends 'base.html' %}

{% block content %}
<h2>Wallet Details</h2>
<ul>
    <li>Public Key: {{ qpt_public_key }}</li>
    <li>Recipient ID: {{ recipient_id }}</li>
</ul>
<button id="refresh-balance">Refresh Balance</button>

<div id="balance">
    <p>QPT Balance: <span id="qpt-balance">{{ qpt_balance }}</span></p>
</div>

<h3>Transfer Funds</h3>
<form id="transfer-form">
    {% csrf_token %}
    <div>
        <label for="currency">Currency:</label>
        <select name="currency" id="currency">
            <option value="QPT">QPT</option>
            <option value="HBAR">HBAR</option>
        </select>
    </div>
    <div>
        <label for="recipient_id">Recipient ID:</label>
        <input type="text" name="recipient_id" id="recipient_id" required>
    </div>
    <div>
        <label for="amount">Amount:</label>
        <input type="number" step="0.01" name="amount" id="amount" required>
    </div>
    <button type="submit">Send</button>
</form>

<div id="transfer-status"></div>

<h3>Transaction History</h3>
<div id="transaction-history"></div>

<button onclick="loadTransactionHistory()">Load History</button>

<script>
function loadTransactionHistory() {
    fetch("{% url 'wallet-history' %}")
    .then(response => response.json())
    .then(data => {
        let html = '<ul>';
        data.transactions.forEach(txn => {
            html += `<li>
                ${txn.created_at} - ${txn.transaction_type} ${txn.amount} ${txn.currency} 
                to ${txn.recipient_id} - ${txn.status}
            </li>`;
        });
        html += '</ul>';
        document.getElementById('transaction-history').innerHTML = html;
    });
}

loadTransactionHistory(); // Auto-load on page load
</script>


<script>
    document.getElementById('transfer-form').addEventListener('submit', (event) => {
        event.preventDefault();

        const formData = new FormData(event.target);

        fetch("{% url 'wallet-transfer' %}", {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById('transfer-status').innerText = data.message;
            } else {
                document.getElementById('transfer-status').innerText = `Error: ${data.message}`;
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>


<script>
    document.getElementById('refresh-balance').addEventListener('click', () => {
        fetch("{% url 'wallet-balance' %}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('qpt-balance').textContent = data.qpt_balance;
            })
            .catch(error => console.error('Error fetching wallet balance:', error));
    });
</script>

{% endblock %}
